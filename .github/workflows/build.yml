name: Build and Test

on:
  workflow_dispatch:

env:
  DOCKER_IMAGE: ghcr.io/lobis/root-geant4-garfield:cpp17_ROOT-v6-25-01_Geant4-v10.4.3_Garfield-4.0
  REST_PATH: /rest/install

jobs:
  Check-Image:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/lobis/root-geant4-garfield:cpp17_ROOT-v6-25-01_Geant4-v10.4.3_Garfield-4.0

    steps:
      - name: Check ROOT is available in non-interactive shell
        run: |
          root-config --version
          root-config --prefix
          root-config --cflags
          root -q
      - name: Check Geant4 is available in non-interactive shell
        run: |
          geant4-config --version
          geant4-config --prefix
          geant4-config --cflags
          geant4-config --datasets
      - name: Check ROOT
        run: |
          root -e 'TTree tree; return 0;' -q
      - name: Check Geant4 by building and runing a basic example
        run: |
          G4_VERSION=$(geant4-config --version)
          G4_INSTALL=$(geant4-config --prefix)
          G4_EXAMPLES=${G4_INSTALL}/share/Geant4-${G4_VERSION}/examples
          echo "Geant4 examples dir: $G4_EXAMPLES"
          cd $G4_EXAMPLES/basic/B1
          mkdir build && cd build
          cmake ..
          make
          ./exampleB1 run1.mac
      - name: Check Garfield is available from ROOT prompt
        run: |
          root -e '
          #include "Garfield/MediumMagboltz.hh"
          using namespace Garfield;
          MediumMagboltz gas;
          return 0;' -q

  Build-and-Install:
    needs: Check-Image
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/lobis/root-geant4-garfield:cpp17_ROOT-v6-25-01_Geant4-v10.4.3_Garfield-4.0

    steps:
      - uses: actions/checkout@v2

      - name: Pull Submodules
        run: yes | python3 pull-submodules.py --clean

      - name: Build and Install
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_INSTALL_PREFIX=${{ env.REST_PATH }} -DREST_WELCOME=OFF -DREST_GARFIELD=ON -DREST_G4=ON -DRESTLIB_DETECTOR=ON -DRESTLIB_RAW=ON -DRESTLIB_TRACK=ON
          make -j$(nproc)
          make install

      - uses: actions/upload-artifact@master
        with:
          name: framework-install
          path: ${{ env.REST_PATH }}

  Basic-Checks:
    needs: Build-and-Install
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/lobis/root-geant4-garfield:cpp17_ROOT-v6-25-01_Geant4-v10.4.3_Garfield-4.0

    steps:
      - uses: actions/checkout@v2

      - uses: actions/download-artifact@master
        with:
          name: framework-install
          path: ${{ env.REST_PATH }}

      - name: REST config
        run: |
          . ${{ env.REST_PATH }}/thisREST.sh
          rest-config --version
          rest-config --libs
          rest-config --flags
          rest-config --commit

      - name: RestRoot
        run: |
          . ${{ env.REST_PATH }}/thisREST.sh
          cd /pipeline/analysistree/
          restRoot -b -q simpleTree.cpp
